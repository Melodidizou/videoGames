
var compteur = 0;
var maxCpt = 16;
var minVideo,maxVideo;
var mobile = true;
var lastVideoPlayed = { "val" : "000"};
var activeEvent = { "val" : false};

function unbindAllKeypress(){
    $(document).unbind('keypress');
}

function unbindAllEvents(){
    $(document).unbind('keydown');
    $(document).unbind('keyup');
    $(document).unbind('keypress');
}

function restartOnLastCheckpoint(){
  changeVideo(lastVideoPlayed["val"]);
}



// Gestion de l'assigmenent des vid√©o clefs par evennement
$(document).ready(function(){

    video.play();

    if(game_json.hasOwnProperty("gameovers")){
      var gameOverMin = game_json.gameovers.idmin;
      var gameOverMax = game_json.gameovers.idmax;
      var gameOverText = game_json.gameovers.textmobile;
      for (var i = gameOverMin; i <= gameOverMax; i++) {
        var videoGameOverId =  i.zeroPad(100);
        $('#video_'+videoGameOverId).on('ended',videoObj,function(event){
          activeEvent['val'] = true;
          loadText(gameOverText,500,mobile);
          $('body').swipe( {
              tap:function(event, target) {
                if(activeEvent['val']){
                  changeVideo(lastVideoPlayed["val"],500);
                }
                activeEvent['val'] = false;
              }
          });
        });
      }
    }

    for (var i = 0; i < game_json.scenario.length; i++) {
      var videoObj = game_json.scenario[i];
      if(videoObj.hasOwnProperty("onstart")){
        $('#video_'+videoObj.id).on('play',videoObj,function(event){
          stopVideo(event.data.onstart.stopvideo);
        });
      }
      if(videoObj.hasOwnProperty("onend")){
        $('#video_'+videoObj.id).on('ended',videoObj,function(event){
          lastVideoPlayed["val"] = ""+videoObj.id;
          unbindAllEvents();
          var text = "";
          if(event.data.onend.hasOwnProperty("textmobile")){
            text = event.data.onend.textmobile;
          }

          var delay = "";
          if(game_json.hasOwnProperty("globaldelay")){
            delay = game_json.globaldelay;
          }
          if(event.data.onend.hasOwnProperty("delay")){
            delay = event.data.onend.delay;
          }
          loadText(text,delay,mobile);
          if(debug){ console.log(event); }

          // Lorsque l'on a un choix multiple
          if(event.data.onend.type == "multichoicebykeypressed"){
            var mvts = {};
            var nextvideomobile = null;
            if(event.data.onend.hasOwnProperty("nextvideomobile")){
              nextvideomobile = event.data.onend.nextvideomobile;
            }
            activeEvent['val'] = true;

            if(event.data.onend.hasOwnProperty("nextvideosmobile")){
              var nextVideos = event.data.onend.nextvideosmobile;
              mvts["left"] = nextVideos['left'];
              mvts["right"] = nextVideos['right'];
              if(nextVideos.hasOwnProperty('up')){
                mvts["up"] = nextVideos['up'];
              }
              if(nextVideos.hasOwnProperty('down')){
                mvts["down"] = nextVideos['down'];
              }
            }
            $('body').swipe( {
              swipe: function(event, direction, distance, duration, fingerCount, fingerData) {
                 if(activeEvent['val']){
                    if(!nextvideomobile){
                      var videoId = mvts[direction];
                      if(videoId.startsWith("redirect")){
                        window.location = window.location.origin +'/game/m/'+ videoId.replace("redirect ","");
                        return false;
                      }else{
                        changeVideo(""+mvts[direction],delay);
                        activeEvent['val'] = false;
                      }
                    }
                  }
                },
                tap: function(event, target) {
                   if(activeEvent['val']){
                     if(nextvideomobile){
                        changeVideo(nextvideomobile,delay);
                        activeEvent['val'] = false;
                      }
                    }
                  }
              });
            }

          // playbykey or playbymouse
          if(event.data.onend.type == "playbykey" || event.data.onend.type == "playbymouse"){
            var tappedFirstTime = false;
            var timeout;
            var isFinished = false;
            var idVideomobiletoplay = event.data.onend.videomobiletoplay;
            var aftervideomobiletoplay = null;
            if(event.data.onend.hasOwnProperty("aftervideomobiletoplay")){
              aftervideomobiletoplay = event.data.onend.aftervideomobiletoplay;
            }
            videoElt = document.getElementById( 'video_'+idVideomobiletoplay );
            activeEvent['val'] = true;
            firstTap = true;
            $('body').swipe( {
              tap:function(event, target) {
                  clearTimeout(timeout);
                  if(activeEvent['val'] && !tappedFirstTime){
                      changeVideo(""+idVideomobiletoplay,'infini',true,500);
                      tappedFirstTime = true;
                    }else if(activeEvent['val']){
                        if(videoElt.paused){
                          videoElt.play();
                          timeout = setTimeout(function(){
                            if(!isFinished){
                              videoElt.pause();
                            }
                          }, 200);
                        }
                    }
                  }
              });
              $(videoElt).on('ended', function(){
                if(aftervideomobiletoplay && !isFinished){
                  changeVideo(""+aftervideomobiletoplay, delay);
                }
                lastVideoPlayed["val"] = ""+idVideomobiletoplay;
                isFinished = true;
               });
          }

          // multibykeypressed
          if(event.data.onend.type == "multibykeypressed"){
            compteur = 0;
            var minVideo=event.data.onend.minVideo;
            var maxVideo=event.data.onend.maxVideo;
            var nextVideoId = event.data.onend.nextvideo;
            var textAfter = event.data.onend.textafter;
            activeEvent['val'] = true;
            $('body').swipe( {
              tap:function(event, target) {
                if(activeEvent['val']){
                  var randkey = Math.floor(Math.random() * (maxVideo-minVideo)) + minVideo;
                  changeVideo(randkey.zeroPad(100),'infini');
                  compteur++;
                  if(maxCpt && (compteur > maxCpt)){
                    lastVideoPlayed["val"] = ""+nextVideoId;
                    changeVideo(""+nextVideoId,'infini');
                    loadText(textAfter,delay,mobile);
                    activeEvent['val'] = false;
                  }
                  $('.reste').text(maxCpt-(compteur)+1);
                }
              }
            });
          }
        });
      }
    }
  });
